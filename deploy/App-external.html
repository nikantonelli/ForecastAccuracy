<!DOCTYPE html>
<html>
<head>
    <title>PI Forecast Accuracy</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ForecastAccuracy",{extend:"Rally.app.App",componentCls:"app",itemId:"rallyApp",progressField:"AcceptedLeafStoryCount",config:{defaultSettings:{fetchLimit:100,EndDate:new Date,StartDate:new Date(Ext.Date.now()-7776e6),removeOutliers:!0}},items:[{xtype:"container",itemId:"chartBox",layout:"hbox"}],getSettingsFields:function(){return[{xtype:"rallyportfolioitemtypecombobox",name:"piType",label:" Portfolio Type",labelWidth:200,valueField:"TypePath"},{xtype:"rallynumberfield",name:"fetchLimit",label:"Max Fetch Limit",labelWidth:200,maxValue:200,minValue:0,allowDecimals:!1},{xtype:"rallydatefield",name:"StartDate",fieldLabel:"Start Date",labelWidth:200,format:"F j, Y"},{xtype:"rallydatefield",name:"EndDate",labelWidth:200,fieldLabel:"End Date",format:"F j, Y"},{xtype:"rallycheckboxfield",fieldLabel:"Remove outliers",name:"removeOutliers"}]},launch:function(){this.showMask("Fetching items with historical data..."),this.model=this.getSetting("piType")||"Portfolioitem/Feature",this.start=new Date(this.getSetting("StartDate")||Ext.Date.now()-7776e6),this.end=new Date(this.getSetting("EndDate")||Ext.Date.now()),this._fetchItems()},onSettingsUpdate:function(){this._clearStatus(),this._fetchItems()},_clearStatus:function(){this.store&&this.store.destroy()},showMask:function(t){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(t))},hideMask:function(){this.getEl()&&this.getEl().unmask()},_fetchItems(){var t=this;t.store=Ext.create("Rally.data.wsapi.Store",{model:t.model,pageSize:t.getSetting("fetchLimit")||200,fetch:["ObjectID","FormattedID","PreliminaryEstimate","RefinedEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimateValue","ActualStartDate","ActualEndDate","PlannedStartDate","PlannedEndDate"],autoLoad:!0,filters:[{property:"ActualEndDate",operator:"<",value:t.end},{property:"ActualEndDate",operator:">",value:t.start}],limit:t.getSetting("fetchLimit")||1/0,listeners:{load:function(e,a,i){i?e.getCount()?(Rally.ui.notify.Notifier.show({message:"Fetched "+e.getCount()+" (of "+e.totalCount+") Items",timeout:5e3}),t._doSizeMetrics(a),t._doDateMetrics(a),t._doRateMetrics(a),t.hideMask()):(Rally.ui.notify.Notifier.showWarning({message:"No Historical Data found within date range"}),t.hideMask()):t.hideMask()}}})},_getHistoricalData:function(t,e){var a=new Deft.Deferred,i=Ext.merge({ObjectID:t.get("ObjectID")},e._getProgressField());return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,compress:!0,removeUnauthorizedSnapshots:!0,pageSize:2e3,listeners:{load:function(t,i,r){r?(e.showMask("Fetched change records for "+ ++e.fetchedCount+" items"),a.resolve(t)):a.reject()}},fetch:["FormattedID","ObjectID","_ValidTo","_ValidFrom",e.progressField],find:i,sort:{_ValidFrom:1}}),a.getPromise()},_getProgressField:function(){return{}},_doSizeMetrics:function(t){for(var e=[],a=0;a<t.length;a++)t[a].get("PreliminaryEstimate")&&e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:t[a].get("LeafStoryPlanEstimateTotal")/t[a].get("PreliminaryEstimateValue")*100,name:t[a].get("FormattedID")});e=_.sortBy(e,["x"]),this._updateSizeMetricsChart(e)},_updateSizeMetricsChart:function(t){this.down("#sizeMetricsChart")&&this.down("#sizeMetricsChart").destroy(),this._drawChart("sizeMetricsChart","Size Prediction Accuracy","Actual vs Predicted Percentage ( Size )",t)},_doDateMetrics:function(t){for(var e=[],a=0;a<t.length;a++){var i=t[a].get("ActualStartDate"),r=t[a].get("ActualEndDate"),o=t[a].get("PlannedStartDate"),s=t[a].get("PlannedEndDate");if(t[a].get("PreliminaryEstimate"))if(i&&r&&o&&s){var n=(new Date(r)-new Date(i))/(new Date(s)-new Date(o))*100;e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:n,name:t[a].get("FormattedID")})}else e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:0,name:t[a].get("FormattedID")})}e=_.sortBy(e,["x"]),this._updateDateMetricsChart(e)},_updateDateMetricsChart:function(t){this.down("#dateMetricsChart")&&this.down("#dateMetricsChart").destroy(),this._drawChart("dateMetricsChart","Duration Prediction Accuracy","Actual vs Predicted Percentage ( Duration )",t)},_doRateMetrics:function(t){for(var e=[],a=0;a<t.length;a++){var i=t[a].get("ActualStartDate"),r=t[a].get("ActualEndDate");if(t[a].get("PreliminaryEstimate"))if(i&&r){var o=6048e5*t[a].get("LeafStoryPlanEstimateTotal")/(new Date(r)-new Date(i));o<100&&e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:o,name:t[a].get("FormattedID")})}else e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:0,name:t[a].get("FormattedID")})}e=_.sortBy(e,["x"]),this._updateRateMetricsChart(e)},_updateRateMetricsChart:function(t){this.down("#rateMetricsChart")&&this.down("#rateMetricsChart").destroy(),this._drawChart("rateMetricsChart","Story Points Delivery","Points per Week",t)},_drawChart:function(t,e,a,i){var r=this;if(this.getSetting("removeOutliers")){var o=(i=_.sortBy(i,"y")).length;i=_.initial(_.rest(i,Math.floor(.1*o))||1,Math.ceil(.1*o)||1)}i=_.sortBy(i,"x");var s=_.groupBy(i,"groupBy"),n=[];_.each(Object.keys(s),function(t){var e=[];_.each(s[t],function(t){e.push(t)}),n.push({name:t,data:e})});var l=1/Math.log1p(i.length);r.down("#chartBox").add({xtype:"rallychart",width:"33%",height:600,loadMask:!1,itemId:t,chartColors:["rgba(27,158,119,"+l+")","rgba(217,95,2,"+l+")","rgba(117,112,179,"+l+")","rgba(231,41,138,"+l+")","rgba(102,166,30,"+l+")","rgba(230,171,2,"+l+")","rgba(166,118,29,"+l+")","rgba(102,102,102,"+l+")"],chartConfig:{chart:{type:"scatter"},title:{text:e+" ("+i.length+" items)"},xAxis:{title:{text:"PreliminaryEstimate Value of "+r.getSetting("piType")},type:"logarithmic"},yAxis:{title:{text:a},type:"logarithmic"},tooltip:{formatter:function(){var t="<span>"+this.point.name+"</span>";return t+="<table>",t+="<tr>",t+="<td>"+r.store.findRecord("FormattedID",this.point.name).get("_refObjectName")+"</td>",t+="</tr>",t+="</table>"},shared:!0,useHTML:!0},plotOptions:{scatter:{marker:{radius:6}}}},chartData:{series:n}})}});

            Rally.launchApp('ForecastAccuracy', {
                name:"PI Forecast Accuracy",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
