<!DOCTYPE html>
<html>
<head>
    <title>PI Forecast Accuracy</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ForecastAccuracy",{extend:"Rally.app.App",componentCls:"app",itemId:"rallyApp",config:{defaultSettings:{fetchLimit:100,EndDate:new Date,plotDate:new Date,StartDate:new Date(Ext.Date.now()-7776e6),removeOutliers:!0}},items:[{xtype:"container",itemId:"chartBox",layout:"hbox"},{xtype:"container",itemId:"mcBox",layout:"vbox"}],getSettingsFields:function(){return[{xtype:"rallyportfolioitemtypecombobox",name:"piType",label:" Portfolio Type",labelWidth:200,valueField:"TypePath"},{xtype:"rallycombobox",name:"plotItemSize",label:" Item Size for MC Plot",labelWidth:200,allowClear:!0,storeConfig:{pageSize:200,limit:1/0,model:"PreliminaryEstimate",sorters:[{property:"Value",direction:"ASC"}]},valueField:"Name"},{xtype:"rallydatefield",name:"plotDate",fieldLabel:"MC Plot Date",labelWidth:200,format:"F j, Y"},{xtype:"rallynumberfield",name:"fetchLimit",label:"Max Fetch Limit",labelWidth:200,maxValue:200,minValue:0,allowDecimals:!1},{xtype:"rallydatefield",name:"StartDate",fieldLabel:"History Start Date",labelWidth:200,format:"F j, Y"},{xtype:"rallydatefield",name:"EndDate",labelWidth:200,fieldLabel:"History End Date",format:"F j, Y"},{xtype:"rallycheckboxfield",fieldLabel:"Remove outliers",name:"removeOutliers"}]},launch:function(){this.showMask("Fetching data for completed items..."),this.model=this.getSetting("piType")||"Portfolioitem/Feature",this.start=new Date(this.getSetting("StartDate")||Ext.Date.now()-7776e6),this.end=new Date(this.getSetting("EndDate")||Ext.Date.now()),this._fetchItems()},onSettingsUpdate:function(){this._clearStatus(),this._fetchItems()},_clearStatus:function(){this.store&&this.store.destroy()},showMask:function(t){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(t))},hideMask:function(){this.getEl()&&this.getEl().unmask()},_fetchItems(){var t=this;t.store=Ext.create("Rally.data.wsapi.Store",{model:t.model,pageSize:t.getSetting("fetchLimit")||200,fetch:["ObjectID","FormattedID","PreliminaryEstimate","RefinedEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimateValue","ActualStartDate","ActualEndDate","PlannedStartDate","PlannedEndDate"],autoLoad:!0,filters:[{property:"ActualEndDate",operator:"<",value:t.end},{property:"ActualEndDate",operator:">",value:t.start},{property:"PreliminaryEstimate.ObjectID",operator:"!=",value:null}],limit:t.getSetting("fetchLimit")||1/0,listeners:{load:function(e,a,i){if(i)if(e.getCount()){Rally.ui.notify.Notifier.show({message:"Fetched "+e.getCount()+" (of "+e.totalCount+") Items",timeout:5e3}),t._doSizeMetrics(a),t._doDateMetrics(a),t._doRateMetrics(a),t.hideMask(),t.fetchedCount=0;var r=[],o=0;for(o=0;o<a.length;o++)t.getSetting("plotItemSize")&&a[o].get("PreliminaryEstimate")._refObjectName!==t.getSetting("plotItemSize")||r.push(t._getHistoricalData(a[o],t));Deft.Promise.all(r).then({success:function(e){t.hideMask(),e=_.filter(e,function(t){return t.data.length>0}),console.log(e),t._addCompletionSpline(e,t),t._drawMcChart(e,t)},failure:function(){console.log("Oops!")},scope:t})}else Rally.ui.notify.Notifier.showWarning({message:"No Historical Data found within date range"}),t.hideMask();else t.hideMask()}}})},_addCompletionSpline:function(t,e){var a=new Date(e.getSetting("plotDate")).valueOf(),i=a;_.each(t,function(t){t.data[t.data.length-1][0]>i&&(i=t.data[t.data.length-1][0])});for(var r=(i-a)/10,o={name:"Completed This Period",type:"spline",yAxis:1,color:"#0f0fff",data:[]};a<i;a+=r)o.data.push([a+r/2,e._findCompletionBetween(t,a,a+r)]);t.push(o)},_findCompletionBetween:function(t,e,a){var i=0;return _.each(t,function(t){var r=new Date(t.data[t.data.length-1][0]);i+=r>e&&r<=a?1:0}),i},_getHistoricalData:function(t,e){var a=new Deft.Deferred,i=Ext.merge({ObjectID:t.get("ObjectID")},e._getProgressField());return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,compress:!0,removeUnauthorizedSnapshots:!0,pageSize:2e3,listeners:{load:function(t,i,r){if(r){e.showMask("Fetched change records for "+ ++e.fetchedCount+" items");var o={name:i[0].get("FormattedID"),type:"line",data:e._createMcSeries(i,e)};a.resolve(o)}else a.reject()},scope:e},fetch:["FormattedID","ObjectID","_ValidTo","_ValidFrom","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal"],find:i,sort:{_ValidFrom:1}}),a.getPromise()},_createMcSeries:function(t,e){var a=[];t=e._trimNonZero(t);var i=new Date;e.getSetting("plotDate")&&(i=new Date(e.getSetting("plotDate")));for(var r=0;r<t.length;r++){var o=0;9999===new Date(t[r].get("_ValidTo")).getFullYear()&&(o=t[r].get("_ValidFrom"));var n=i.valueOf()+new Date(o||t[r].get("_ValidTo")).valueOf()-new Date(t[0].get("_ValidFrom")).valueOf();a.push([n,t[r].get("LeafStoryPlanEstimateTotal")-t[r].get("AcceptedLeafStoryPlanEstimateTotal")])}return a},_trimNonZero:function(t){return _.filter(t,function(t){return t.get("LeafStoryPlanEstimateTotal")>0})},_getProgressField:function(){return{}},_doSizeMetrics:function(t){for(var e=[],a=0;a<t.length;a++)t[a].get("PreliminaryEstimate")&&e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:t[a].get("LeafStoryPlanEstimateTotal")/t[a].get("PreliminaryEstimateValue")*100,name:t[a].get("FormattedID")});e=_.sortBy(e,["x"]),this._updateSizeMetricsChart(e)},_updateSizeMetricsChart:function(t){this.down("#sizeMetricsChart")&&this.down("#sizeMetricsChart").destroy(),this._drawMetricsChart("sizeMetricsChart","Size Prediction Accuracy","Actual vs Predicted Percentage ( Size )",t)},_doDateMetrics:function(t){for(var e=[],a=0;a<t.length;a++){var i=t[a].get("ActualStartDate"),r=t[a].get("ActualEndDate"),o=t[a].get("PlannedStartDate"),n=t[a].get("PlannedEndDate");if(t[a].get("PreliminaryEstimate"))if(i&&r&&o&&n){var l=(new Date(r)-new Date(i))/(new Date(n)-new Date(o))*100;e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:l,name:t[a].get("FormattedID")})}else e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:0,name:t[a].get("FormattedID")})}e=_.sortBy(e,["x"]),this._updateDateMetricsChart(e)},_updateDateMetricsChart:function(t){this.down("#dateMetricsChart")&&this.down("#dateMetricsChart").destroy(),this._drawMetricsChart("dateMetricsChart","Duration Prediction Accuracy","Actual vs Predicted Percentage ( Duration )",t)},_doRateMetrics:function(t){for(var e=[],a=0;a<t.length;a++){var i=t[a].get("ActualStartDate"),r=t[a].get("ActualEndDate");if(t[a].get("PreliminaryEstimate"))if(i&&r){var o=6048e5*t[a].get("LeafStoryPlanEstimateTotal")/(new Date(r)-new Date(i));o<100&&e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:o,name:t[a].get("FormattedID")})}else e.push({groupBy:t[a].get("PreliminaryEstimate")._refObjectName,x:t[a].get("PreliminaryEstimateValue"),y:0,name:t[a].get("FormattedID")})}e=_.sortBy(e,["x"]),this._updateRateMetricsChart(e)},_updateRateMetricsChart:function(t){this.down("#rateMetricsChart")&&this.down("#rateMetricsChart").destroy(),this._drawMetricsChart("rateMetricsChart","Story Points Delivery","Points per Week",t)},_drawMetricsChart:function(t,e,a,i){var r=this;if(i.length){if(this.getSetting("removeOutliers")){var o=(i=_.sortBy(i,"y")).length;i=_.initial(_.rest(i,Math.floor(.1*o))||1,Math.ceil(.1*o)||1)}i=_.sortBy(i,"x");var n=_.groupBy(i,"groupBy"),l=[];_.each(Object.keys(n),function(t){var e=[];_.each(n[t],function(t){e.push(t)}),l.push({name:t,data:e})});var s=1/Math.log1p(i.length);r.down("#chartBox").add({xtype:"rallychart",width:"33%",height:600,loadMask:!1,itemId:t,chartColors:["rgba(27,158,119,"+s+")","rgba(217,95,2,"+s+")","rgba(117,112,179,"+s+")","rgba(231,41,138,"+s+")","rgba(102,166,30,"+s+")","rgba(230,171,2,"+s+")","rgba(166,118,29,"+s+")","rgba(102,102,102,"+s+")"],chartConfig:{chart:{type:"scatter"},title:{text:e+" ("+i.length+" items)"},xAxis:{title:{text:"PreliminaryEstimate Value of "+r.getSetting("piType")},type:"logarithmic"},yAxis:{title:{text:a},type:"logarithmic"},tooltip:{formatter:function(){var t="<span>"+this.point.name+"</span>";return t+="<table>",t+="<tr>",t+="<td>"+r.store.findRecord("FormattedID",this.point.name).get("_refObjectName")+"</td>",t+="</tr>",t+="</table>"},shared:!0,useHTML:!0},plotOptions:{scatter:{marker:{radius:6}}}},chartData:{series:l}})}},_drawMcChart:function(t,e){var a=1/Math.log1p(t.length);this.down("#mcBox").add({xtype:"rallychart",width:"100%",height:600,loadMask:!1,itemId:"mcChart",chartColors:["rgba(27,158,119,"+a+")","rgba(217,95,2,"+a+")","rgba(117,112,179,"+a+")","rgba(231,41,138,"+a+")","rgba(102,166,30,"+a+")","rgba(230,171,2,"+a+")","rgba(166,118,29,"+a+")","rgba(102,102,102,"+a+")"],chartConfig:{chart:{},legend:{enabled:!1},title:{text:" Probabalistic Forecast for "+(e.getSetting("plotItemSize")||"All sizes")},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{title:{text:"Story Point Burndown",style:{color:"rgba(0,180,0,0.8)"}}},{title:{text:"Completion Rate",style:{color:"#0f0fff"}},opposite:!0}],plotOptions:{line:{color:"rgba(0,180,0,0.2)",marker:{enabled:!1},states:{hover:{lineWidthPlus:5}}}}},chartData:{series:t}})}});

            Rally.launchApp('ForecastAccuracy', {
                name:"PI Forecast Accuracy",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .app{background-color:paleblue}
    </style>
</head>
<body>
</body>
</html>
