<!DOCTYPE html>
<html>
<head>
    <title>PI Forcecast Accuracy</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ForcastAccuracy",{extend:"Rally.app.App",componentCls:"app",itemId:"rallyApp",progressField:"AcceptedLeafStoryCount",config:{defaultSettings:{fetchLimit:100,EndDate:new Date,StartDate:new Date(Ext.Date.now()-7776e6)}},items:[{xtype:"container",itemId:"chartBox",layout:"hbox"}],getSettingsFields:function(){return[{xtype:"rallyportfolioitemtypecombobox",name:"piType",label:" Portfolio Type",labelWidth:200,valueField:"TypePath"},{xtype:"rallynumberfield",name:"fetchLimit",label:"Max Fetch Limit",labelWidth:200,maxValue:200,minValue:1,allowDecimals:!1},{xtype:"rallydatefield",name:"StartDate",fieldLabel:"Start Date",labelWidth:200,format:"F j, Y"},{xtype:"rallydatefield",name:"EndDate",labelWidth:200,fieldLabel:"End Date",format:"F j, Y"}]},launch:function(){this.showMask("Fetching items with historical data..."),this.model=this.getSetting("piType")||"Portfolioitem/Feature",this.start=new Date(this.getSetting("StartDate")||Ext.Date.now()-7776e6),this.end=new Date(this.getSetting("EndDate")||Ext.Date.now()),this._fetchItems()},onSettingsUpdate:function(){this._clearStatus(),this._fetchItems()},_clearStatus:function(){this.store&&this.store.destroy()},showMask:function(t){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(t))},hideMask:function(){this.getEl()&&this.getEl().unmask()},_fetchItems(){var t=this;t.store=Ext.create("Rally.data.wsapi.Store",{model:t.model,pageSize:t.getSetting("fetchLimit")||200,fetch:["ObjectID","FormattedID","PreliminaryEstimate","RefinedEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimateValue","ActualStartDate","ActualEndDate","PlannedStartDate","PlannedEndDate"],autoLoad:!0,filters:[{property:"ActualEndDate",operator:"<",value:t.end},{property:"ActualEndDate",operator:">",value:t.start}],listeners:{load:function(e,a,i){if(i)if(e.getCount()){Rally.ui.notify.Notifier.show({message:"Working with "+e.getCount()+" (of "+e.totalCount+") Historical Data Items",timeout:5e3}),t.sizeMetrics=[];var r=0;for(r=0;r<e.getCount();r++)a[r].get("PreliminaryEstimate")&&t.sizeMetrics.push({groupBy:a[r].get("PreliminaryEstimate")._refObjectName,x:a[r].get("PreliminaryEstimateValue"),y:a[r].get("LeafStoryPlanEstimateTotal")/a[r].get("PreliminaryEstimateValue")*100,name:a[r].get("FormattedID")});for(t.sizeMetrics=_.sortBy(t.sizeMetrics,["x"]),t._updateSizeMetricsChart(),t.dateMetrics=[],r=0;r<e.getCount();r++){var s=a[r].get("ActualStartDate"),o=a[r].get("ActualEndDate"),n=a[r].get("PlannedStartDate"),l=a[r].get("PlannedEndDate");if(a[r].get("PreliminaryEstimate"))if(s&&o&&n&&l){var d=(new Date(o)-new Date(s))/(new Date(l)-new Date(n))*100;t.dateMetrics.push({groupBy:a[r].get("PreliminaryEstimate")._refObjectName,x:a[r].get("PreliminaryEstimateValue"),y:d,name:a[r].get("FormattedID")})}else t.dateMetrics.push({groupBy:a[r].get("PreliminaryEstimate")._refObjectName,x:a[r].get("PreliminaryEstimateValue"),y:0,name:a[r].get("FormattedID")})}t.dateMetrics=_.sortBy(t.dateMetrics,["x"]),t._updateDateMetricsChart(),t.hideMask()}else Rally.ui.notify.Notifier.showWarning({message:"No Historical Data found within date range"}),t.hideMask();else t.hideMask()}}})},_getHistoricalData:function(t,e){var a=new Deft.Deferred,i=Ext.merge({ObjectID:t.get("ObjectID")},e._getProgressField());return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,compress:!0,removeUnauthorizedSnapshots:!0,pageSize:2e3,listeners:{load:function(t,i,r){r?(e.showMask("Fetched change records for "+ ++e.fetchedCount+" items"),a.resolve(t)):a.reject()}},fetch:["FormattedID","ObjectID","_ValidTo","_ValidFrom",e.progressField],find:i,sort:{_ValidFrom:1}}),a.getPromise()},_getProgressField:function(){return{}},_updateSizeMetricsChart:function(){this.down("#sizeMetricsChart")&&this.down("#sizeMetricsChart").destroy(),this._drawChart("sizeMetricsChart","Size",this.sizeMetrics)},_updateDateMetricsChart:function(){this.down("#dateMetricsChart")&&this.down("#dateMetricsChart").destroy(),this._drawChart("dateMetricsChart","Duration",this.dateMetrics)},_drawChart:function(t,e,a){var i=this,r=_.groupBy(a,"groupBy"),s=[];_.each(Object.keys(r),function(t){var e=[];_.each(r[t],function(t){e.push(t)}),s.push({name:t,data:e})}),i.down("#chartBox").add({xtype:"rallychart",width:"50%",height:600,loadMask:!1,itemId:t,chartColors:["rgba(27,158,119,0.4)","rgba(217,95,2,0.4)","rgba(117,112,179,0.4)","rgba(231,41,138)","rgba(102,166,30,0.4)","rgba(230,171,2,0.4)","rgba(166,118,29,0.4)","rgba(102,102,102,0.4)"],chartConfig:{chart:{type:"scatter"},title:{text:e+" Prediction Accuracy"},xAxis:{title:{text:"PreliminaryEstimate Value of "+i.getSetting("piType")},type:"logarithmic"},yAxis:{title:{text:"Actual vs Predicted Percentage ("+e+")"},type:"logarithmic"},tooltip:{formatter:function(){var t="<span>"+this.point.name+"</span>";return t+="<table>",t+="<tr>",t+="<td>"+i.store.findRecord("FormattedID",this.point.name).get("_refObjectName")+"</td>",t+="</tr>",t+="</table>"},shared:!0,useHTML:!0},plotOptions:{scatter:{marker:{radius:6}}}},chartData:{series:s}})}});

            Rally.launchApp('ForcastAccuracy', {
                name:"PI Forcecast Accuracy",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
